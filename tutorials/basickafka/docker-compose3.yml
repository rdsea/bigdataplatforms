#check https://github.com/bitnami/containers/tree/main/bitnami/kafka
#for info about bitnami kafka container and configuration
# we use KRaft so make sure you also read the quickstart in:
# https://kafka.apache.org/documentation/#quickstart
version: '3.5'

x-kafka: &kafka
  image: 'bitnami/kafka:latest'
  restart: always

networks:
  kafka-tutorials:
    name: kafka-tutorials
    driver: bridge
    #external: true

services:
  
  kafka0:
    <<: *kafka
    ports:
      - "9092:9092"
      #- "19092:19092"
    networks:
      - kafka-tutorials
    environment:
      - KAFKA_BROKER_ID=0
      - KAFKA_CFG_NODE_ID=0
      - KAFKA_ENABLE_KRAFT=yes
      # can be generated by running: $docker run -it  bitnami/kafka:latest kafka-storage.sh random-uuid
      - KAFKA_KRAFT_CLUSTER_ID=wbVxbCvYQjirKlUfvSetRg
      - KAFKA_CFG_PROCESS_ROLES=controller,broker
      - KAFKA_CFG_LISTENERS=BROKER://:9092,CONTROLLER://:19092
      #correct and change ip 192.168.8.106 to allow connections from the other machines
      - KAFKA_CFG_ADVERTISED_LISTENERS=BROKER://192.168.8.106:9092
      - KAFKA_CFG_LISTENER_SECURITY_PROTOCOL_MAP=CONTROLLER:PLAINTEXT,BROKER:PLAINTEXT
      #- KAFKA_CFG_CONTROLLER_QUORUM_VOTERS=0@192.168.8.106:19092,1@192.168.8.106:19093,2@192.168.8.106:19094
      - KAFKA_CFG_CONTROLLER_QUORUM_VOTERS=0@kafka0:19092,1@kafka1:19093,2@kafka2:19094
      - KAFKA_CFG_CONTROLLER_LISTENER_NAMES=CONTROLLER
      - KAFKA_CFG_INTER_BROKER_LISTENER_NAME=BROKER
      - KAFKA_CFG_SASL_MECHANISM_INTER_BROKER_PROTOCOL=PLAIN
      - ALLOW_PLAINTEXT_LISTENER=yes
      - KAFKA_CFG_OFFSETS_TOPIC_REPLICATION_FACTOR=3
    volumes:
      - kafka0_data:/tmp/bitnami/kafka
  kafka1:
    <<: *kafka
    ports:
      - "9093:9093"
      #- "19093:19093"
    networks:
      - kafka-tutorials
    environment:
      - KAFKA_BROKER_ID=1
      - KAFKA_CFG_NODE_ID=1
      - KAFKA_ENABLE_KRAFT=yes
      - KAFKA_KRAFT_CLUSTER_ID=wbVxbCvYQjirKlUfvSetRg
      - KAFKA_CFG_PROCESS_ROLES=controller,broker
      - KAFKA_CFG_LISTENERS=BROKER://:9093,CONTROLLER://:19093
        #correct and change ip 192.168.8.106 to allow connections from the other machines
      - KAFKA_CFG_ADVERTISED_LISTENERS=BROKER://192.168.8.106:9093
      - KAFKA_CFG_LISTENER_SECURITY_PROTOCOL_MAP=CONTROLLER:PLAINTEXT,BROKER:PLAINTEXT
      #- KAFKA_CFG_CONTROLLER_QUORUM_VOTERS=0@192.168.8.106:19092,1@192.168.8.106:19093,2@192.168.8.106:19094
      - KAFKA_CFG_CONTROLLER_QUORUM_VOTERS=0@kafka0:19092,1@kafka1:19093,2@kafka2:19094
      - KAFKA_CFG_CONTROLLER_LISTENER_NAMES=CONTROLLER
      - KAFKA_CFG_INTER_BROKER_LISTENER_NAME=BROKER
      - KAFKA_CFG_SASL_MECHANISM_INTER_BROKER_PROTOCOL=PLAIN
      - ALLOW_PLAINTEXT_LISTENER=yes
      - KAFKA_CFG_OFFSETS_TOPIC_REPLICATION_FACTOR=3
    volumes:
      - kafka1_data:/tmp/bitnami/kafka
  kafka2:
    <<: *kafka
    ports:
      - "9094:9094"
      #- "19094:19094"
    networks:
      - kafka-tutorials
    environment:
      - KAFKA_BROKER_ID=2
      - KAFKA_CFG_NODE_ID=2
      - KAFKA_ENABLE_KRAFT=yes
      - KAFKA_KRAFT_CLUSTER_ID=wbVxbCvYQjirKlUfvSetRg
      - KAFKA_CFG_PROCESS_ROLES=controller,broker
      - KAFKA_CFG_LISTENERS=BROKER://:9094,CONTROLLER://:19094
      #correct and change ip 192.168.8.106 to allow connections from the other machines
      - KAFKA_CFG_ADVERTISED_LISTENERS=BROKER://192.168.8.106:9094  
      - KAFKA_CFG_LISTENER_SECURITY_PROTOCOL_MAP=CONTROLLER:PLAINTEXT,BROKER:PLAINTEXT
      #- KAFKA_CFG_CONTROLLER_QUORUM_VOTERS=0@192.168.8.106:19092,1@192.168.8.106:19093,2@192.168.8.106:19094
      - KAFKA_CFG_CONTROLLER_QUORUM_VOTERS=0@kafka0:19092,1@kafka1:19093,2@kafka2:19094
      - KAFKA_CFG_CONTROLLER_LISTENER_NAMES=CONTROLLER
      - KAFKA_CFG_INTER_BROKER_LISTENER_NAME=BROKER
      - KAFKA_CFG_SASL_MECHANISM_INTER_BROKER_PROTOCOL=PLAIN
      - ALLOW_PLAINTEXT_LISTENER=yes
      - KAFKA_CFG_OFFSETS_TOPIC_REPLICATION_FACTOR=3
    volumes:
      - kafka2_data:/tmp/bitnami/kafka

volumes:
  kafka0_data:
    driver: local
  kafka1_data:
    driver: local
  kafka2_data:
    driver: local
